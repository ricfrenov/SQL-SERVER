/* Quando um livro for vendido, deve-se abater a quantidade que está sendo vendida do estoque. Acrescente o campo Nível de Estoque na tabela Livro. Deve-se atribuir o nível de estoque do livro, sendo Alto quando a quantidade em estoque for maior do que 100, Médio quando a quantidade for maior que 50 e menor ou igual a 100 e Baixo quando a quantidade for menor ou igual a 50. */

ALTER TABLE LIVRO
ADD NIVEL_ESTOQUE CHAR(10) DEFAULT 'BAIXO';

--TRIGGER PARA ATUALIZAR A QUANTIDADE DO LIVRO VENDIDO
CREATE TRIGGER TR_ATERAR_QUANTIDADE_AFTER_INSERT ON ITEM_VENDA
AFTER INSERT

AS

BEGIN

	DECLARE @QUANT_VENDA INT,
			@COD_LIVRO INT

	SELECT @QUANT_VENDA = QUANTIDADE, @COD_LIVRO = CODIGO_LIVRO
	FROM INSERTED;

	UPDATE LIVRO SET
	QUANTIDADE_EXEMPLAR = QUANTIDADE_EXEMPLAR - @QUANT_VENDA
	WHERE CODIGO_LIVRO = @COD_LIVRO;


END;

--TRIGGER PARA ATUALIZAR NÍVEL 
CREATE TRIGGER TR_ATUALIZAR_NIVEL ON LIVRO
AFTER UPDATE

AS

BEGIN

DECLARE	@CODIGO_LIVRO INT,
		@QUANTIDADE INT;
		
		SELECT @QUANTIDADE = QUANTIDADE_EXEMPLAR,
			   @CODIGO_LIVRO = CODIGO_LIVRO FROM INSERTED
			   	
				IF @QUANTIDADE > 100
				UPDATE LIVRO
				SET NIVEL_ESTOQUE = 'ALTO'
				WHERE CODIGO_LIVRO = @CODIGO_LIVRO;

				ELSE IF @QUANTIDADE >50 AND @QUANTIDADE <=100
				UPDATE LIVRO
				SET NIVEL_ESTOQUE = 'MEDIO'
				WHERE CODIGO_LIVRO = @CODIGO_LIVRO;

				ELSE IF @QUANTIDADE <=50
				UPDATE LIVRO
				SET NIVEL_ESTOQUE = 'BAIXO'
				WHERE CODIGO_LIVRO = @CODIGO_LIVRO;

END;

